<?php# jSale v1.431# http://jsale.biz# Подключение настроекinclude_once dirname(__FILE__) . '/../config.inc.php';# Вывод ошибокif ($config['errors'] === true){	error_reporting(E_ALL); # Уровень вывода ошибок	ini_set('display_errors', 'on'); # Вывод ошибок включён}# Логирование ошибокif ($config['error_logging'] === true){	ini_set("log_errors", 'on'); # Логирование включено	ini_set("error_log", dirname(__FILE__) . '/error_log.txt'); # Путь файла с логами}# Кодировкаheader('Content-type: text/html; charset=' . $config['encoding']);$no_header = true;if ($config['partner']['enabled'] !== true){	$content = '<h1>Партнёрская программа отключена администратором</h1>	<p>К сожалению, вы не можете зарегистрироваться.</p>';		# Вывод дизайна	include_once dirname(__FILE__) . '/_menu.php';	include_once dirname(__FILE__) . '/../design/partnerCreate.tpl.php';	die;}# Подключение модулейinclude_once dirname(__FILE__) . '/../modules/M_DB.inc.php';$mDB = M_DB::Instance();# Формирование GET запроса (на случай PHP как CGI)parse_str(parse_url($_SERVER['REQUEST_URI'], PHP_URL_QUERY), $_GET);# Обработка имени файла$file = str_replace(dirname(__FILE__) . '/', '', (__FILE__));$file = str_replace('.php', '', $file);if (!isset($_GET['code']) && $config['partner']['invites'] === true){	$content = '	<h1>Введите пригласительный</h1><br/>	<form method="get" class="form-inline">		<p class="text-info">Регистрация в партнёрской программе только по приглашению.</p>		<p>Введите код приглашения здесь:			<input type="text" name="code" value="" class="input-small" placeholder="Инвайт">			<button class="btn" name="submit">Ввести</button>		</p>	</form>';}elseif (isset($_GET['code']) && $config['partner']['invites'] === true){	$ref_code = trim($_GET['code']);		$referer = $mDB->GetItemsByParam('partner', 'code', $ref_code);		if ($ref_code == $config['partner']['admin_invite'])	{		$registation_access = true;		$id_referer = '';	}	elseif ($referer == false)	{		$content = '		<h1>Ошибка!</h1><br/>		<form method="get" class="form-inline">			<p class="text-error">Извините, этот код не действителен. Видимо вы ошиблись.</p>			<p>Попробуйте ввести другой:				<input type="text" name="code" value="' . $ref_code . '" class="input-small" placeholder="Инвайт">				<button class="btn" name="submit">Ввести</button>			</p>		</form>';	}	else	{		$registation_access = true;		$id_referer = $referer[0]['id_partner'];	}}elseif (isset($_GET['code']) && $config['partner']['invites'] === false){	$ref_code = trim($_GET['code']);	$referer = $mDB->GetItemsByParam('partner', 'code', $ref_code);	if (isset($referer[0]['id_partner']))		$id_referer = $referer[0]['id_partner'];	$registation_access = true;}else	$registation_access = true;if (isset($registation_access) && $registation_access === true){	$email = (isset($_POST['email'])) ? trim($_POST['email']) : '';	$password = (isset($_POST['password'])) ? trim($_POST['password']) : '';	$content = '	<h1>Регистрация</h1><br/>	<form action="" method="post" class="form-horizontal">		<p class="text-info">Введите действительный email адрес и пароль.</p>		<div class="control-group">			<label class="control-label" for="email">Email:</label>			<div class="controls">				<input type="email" name="email" value="' . $email . '" class="input-medium" placeholder="Email" required>			</div>		</div>		<div class="control-group">			<label class="control-label" for="inputPassword">Пароль:</label>			<div class="controls">				<input type="password" name="password" value="' . $password . '" class="input-medium" placeholder="Пароль" required>			</div>		</div>		<div class="control-group">			<div class="controls">				<button type="submit" name="create" class="btn btn-success">Зарегистрироваться</button>			</div>		</div>	</form>';}if (isset($_POST['create'])){	$referer = (isset($id_referer)) ? $id_referer : '';		if ($mDB->IssetItemByParam('partner', 'email', $email))	{		$message = 'В базе уже есть партнёр с таким email. Введите другой или воспользуйтесь <a href="' . $config['sitelink'] . $config['dir'] . 'partner/restore.php">восстановлением пароля</a>.';	}	else	{		# Сохранение в базу		$code = $mDB->GenerateCode(6, false);		while ($mDB->IssetItem('partner', $code))			$code = $mDB->GenerateCode(6, false);		$params = array (			'email' => $email,			'password' => $password,			'code' => $code,			'referer' => $referer		);				$mDB->CreateItem('partner', $params, true);				# Отправки письма о регистрации		include_once dirname(__FILE__) . '/../modules/M_Email.inc.php';		$mEmail = M_Email::Instance();				$сontent = $mEmail->PreparePartnerRegister($email, $password, $code, $config);				$mEmail->SendEmail($email, $config['email']['answer'], $config['email']['subjectPartnerRegister'], $сontent, $config['email']['answerName'], $config['encoding']);				$content = '		<h1>Поздравляю!</h1><br/>		<p>Вы успешно зарегистрированы в партнёрской программе. Ваш код: ' . $code . '</p>		<p>Можете войти в <a href="index.php">свой кабинет</a>, используя свой email и пароль.</p>		';	}}# Вывод дизайнаinclude_once dirname(__FILE__) . '/_menu.php';include_once dirname(__FILE__) . '/../design/partnerCreate.tpl.php';